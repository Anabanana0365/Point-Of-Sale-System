<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí Point of Sale System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #pdfPreview {
            max-height: 400px;
            overflow: auto;
        }
        #pdfCanvas {
            width: 100%;
        }
        #lastSaved {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.875rem;
            color: #4b5563;
        }
        #madeBy {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 0.875rem;
            color: #4b5563;
        }
        #receiptModal, #productModal {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .product-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: scale(1.05);
        }
        .product-card img {
            object-fit: cover;
            height: 100px;
            width: 100%;
        }
        .product-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .cart-button {
            flex: 1;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .cart-button:disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .dark body {
            background-color: #1f2937;
            color: #f9fafb;
        }
        .dark .bg-white {
            background-color: #374151;
        }
        .dark .text-gray-800 {
            color: #f9fafb;
        }
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        .dark .bg-gray-50 {
            background-color: #4b5563;
        }
        .dark .border-gray-300 {
            border-color: #6b7280;
        }
        .dark .bg-blue-600 {
            background-color: #2563eb;
        }
        .dark .bg-green-600 {
            background-color: #16a34a;
        }
        .dark .bg-red-600 {
            background-color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Receipt</h2>
                <span onclick="closeReceipt()" class="text-3xl cursor-pointer text-gray-600 hover:text-gray-800">√ó</span>
            </div>
            <p class="text-sm text-gray-600 mb-4">To email the receipt, click 'Email Receipt' to copy the PDF data and paste it into your email client.</p>
            <div id="receiptContent" class="mb-6 text-gray-700"></div>
            <div id="pdfPreview" class="mb-6 border border-gray-200 rounded p-2"></div>
            <button onclick="emailReceipt()" class="cart-button bg-blue-600 text-white hover:bg-blue-700">üìß Email Receipt</button>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-4xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Select Product</h2>
                <span onclick="closeProductModal()" class="text-3xl cursor-pointer text-gray-600 hover:text-gray-800">√ó</span>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                <select id="categoryFilter" onchange="filterProductsByCategory()" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    <option value="all">All Categories</option>
                </select>
            </div>
            <div id="productGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4"></div>
            <div id="quantitySelector" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Selected Product: <span id="selectedProductName"></span></label>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="decreaseQuantity()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">-</button>
                    <input type="number" id="quantity" min="1" value="1" class="w-20 text-center border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" readonly>
                    <button onclick="increaseQuantity()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">+</button>
                </div>
                <button onclick="addToCart()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Add to Cart</button>
                <button onclick="cancelSelection()" class="w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600 transition">Cancel</button>
            </div>
        </div>
    </div>

    <div id="lastSaved" class="text-sm text-gray-600">Last Saved: Never</div>
    <div id="madeBy" class="text-sm text-gray-600">Made with ‚ù§ by Anabanana0365</div>

    <div class="w-full max-w-5xl">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-gray-800">üõí Point of Sale System</h1>
            <button onclick="toggleDarkMode()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">Toggle Dark Mode</button>
        </div>
        <div class="tabs flex space-x-2 mb-6">
            <button onclick="showTab('cashier')" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Checkout</button>
            <button onclick="showTab('admin')" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Admin</button>
            <button onclick="showTab('settings')" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">Settings</button>
        </div>

        <div id="cashier" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Add Products</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Scan Barcode:</label>
                        <input type="text" id="barcodeInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" onkeypress="if(event.key === 'Enter') quickAddToCart()">
                    </div>
                    <button onclick="openProductModal()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition mb-4">Select Product</button>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Customer Name:</label>
                        <input type="text" id="customerName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter customer name">
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Customer Email:</label>
                        <input type="email" id="customerEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter customer email">
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Discount Code:</label>
                        <input type="text" id="discountCode" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <button onclick="applyDiscount()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition mt-2">Apply Discount</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Cart</h2>
                    <ul id="cartItems" class="space-y-2 mb-4"></ul>
                    <p class="text-lg font-semibold text-gray-800">Total: <span id="total">0</span> <span id="currencySymbol">$</span></p>
                    <div class="flex flex-wrap gap-2 mt-4">
                        <button onclick="registerPurchase()" class="cart-button bg-green-600 text-white hover:bg-green-700">üõçÔ∏è Register Purchase</button>
                        <button onclick="generateReceipt()" class="cart-button bg-blue-600 text-white hover:bg-blue-700">üìÑ Generate Receipt</button>
                        <button id="downloadButton" onclick="downloadReceipt()" class="cart-button bg-blue-600 text-white hover:bg-blue-700" disabled>üì• Download PDF</button>
                        <button id="printButton" onclick="printReceipt()" class="cart-button bg-green-600 text-white hover:bg-green-700" disabled>üñ®Ô∏è Print Receipt</button>
                        <button onclick="clearCart()" class="cart-button bg-red-600 text-white hover:bg-red-700">üóëÔ∏è Clear Cart</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin" class="tab-content hidden">
            <div id="adminLogin" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Admin Login</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Admin Password:</label>
                        <input type="password" id="adminCode" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onkeypress="if(event.key === 'Enter') adminLogin()">
                    </div>
                    <button onclick="adminLogin()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Log In</button>
                </div>
            </div>
            <div id="adminPanel" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Manage Products</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Product Name:</label>
                                <input type="text" id="productName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Price (USD):</label>
                                <input type="number" id="productPrice" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Stock:</label>
                                <input type="number" id="productStock" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Barcode:</label>
                                <input type="text" id="productBarcode" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Category:</label>
                                <select id="productCategory" class="mt-1 blockCHS w-full border-gray-300 rounded-md shadow-sm">
                                    <option value="General">General</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Image (Optional):</label>
                                <input type="file" id="productImage" accept="image/*" class="mt-1 block w-full">
                                <img id="imagePreview" class="hidden mt-2 max-w-full h-32 object-cover rounded" src="" alt="Preview">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Eligible for Discount:</label>
                                <div class="flex space-x-4">
                                    <label><input type="radio" name="canDiscount" value="true" class="mr-1"> Yes</label>
                                    <label><input type="radio" name="canDiscount" value="false" checked class="mr-1"> No</label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Bulk Discount (Buy X for Discount):</label>
                                <input type="number" id="bulkQuantity" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Bulk Discount Percentage:</label>
                                <input type="number" id="bulkDiscount" min="0" max="100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="addProduct()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Add Product</button>
                                <button onclick="updateProduct()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Update Product</button>
                            </div>
                            <h3 class="text-lg font-semibold mt-4 text-gray-800">Existing Products</h3>
                            <ul id="productList" class="space-y-2"></ul>
                        </div>
                        <h2 class="text-xl font-semibold mt-6 mb-4 text-gray-800">Manage Categories</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Category Name:</label>
                                <input type="text" id="categoryName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="addCategory()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Add Category</button>
                                <button onclick="updateCategory()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Update Category</button>
                            </div>
                            <h3 class="text-lg font-semibold mt-4 text-gray-800">Existing Categories</h3>
                            <ul id="categoryList" class="space-y-2"></ul>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Manage Discount Codes</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Code:</label>
                                <input type="text" id="discountCodeInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Discount (%):</label>
                                <input type="number" id="discountPercent" min="0" max="100" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="addDiscountCode()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Add Discount Code</button>
                                <button onclick="updateDiscountCode()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Update Discount Code</button>
                            </div>
                            <h3 class="text-lg font-semibold mt-4 text-gray-800">Existing Discount Codes</h3>
                            <ul id="discountCodeList" class="space-y-2"></ul>
                        </div>
                        <h2 class="text-xl font-semibold mt-6 mb-4 text-gray-800">Sales History</h2>
                        <p class="text-lg font-semibold text-gray-800 mb-2">Total Earnings: <span id="totalEarnings">0</span> <span id="earningsCurrency">$</span></p>
                        <p class="text-sm text-gray-600 mb-2">Storage Usage: <span id="storageUsage">0 KB</span></p>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="exportSalesToCSV()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Export Sales to CSV</button>
                            <button onclick="clearOldSales()" class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 transition">Clear Sales Older Than 30 Days</button>
                        </div>
                        <ul id="salesList" class="space-y-2"></ul>
                    </div>
                </div>
                <div class="flex space-x-2 mt-6">
                    <button onclick="adminLogout()" class="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 transition">Log Out</button>
                    <button onclick="clearAllData()" class="flex-1 bg-red-700 text-white py-2 rounded hover:bg-red-800 transition">Clear All Data</button>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Store Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Store Name:</label>
                        <input type="text" id="storeName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter store name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Address:</label>
                        <input type="text" id="storeAddress" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter address">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">VAT Number:</label>
                        <input type="text" id="storeOrgNr" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter VAT number">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="storeEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter email">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Phone Number:</label>
                        <input type="tel" id="storePhone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter phone number">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Currency:</label>
                        <select id="storeCurrency" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            <option value="$">USD ($)</option>
                            <option value="‚Ç¨">EUR (‚Ç¨)</option>
                            <option value="kr">NOK (kr)</option>
                        </select>
                    </div>
                    <button onclick="saveStoreInfo()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let discountCodes = JSON.parse(localStorage.getItem('discountCodes')) || [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || ['General'];
        let storeInfo = JSON.parse(localStorage.getItem('storeInfo')) || {
            name: 'Your company Ltd',
            address: '123 Main Street, New York 0155, USA',
            orgNr: 'VAT 123 456 789',
            email: 'contact@example.com',
            phone: '123-456-7890',
            currency: '$'
        };
        let selectedProduct = null;
        let selectedDiscountCode = null;
        let appliedDiscount = null;
        let total = 0;
        let pdfDoc = null;
        let selectedProductId = null;
        let selectedCategory = null;

        // Currency conversion rates (static, as of estimated June 30, 2025)
        const exchangeRates = {
            '$': 1, // USD (base)
            '‚Ç¨': 0.93, // 1 USD = 0.93 EUR
            'kr': 10.70 // 1 USD = 10.70 NOK
        };

        // Initialize theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
        }

        function updateLastSaved() {
            const now = new Date();
            const timeString = now.toLocaleString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('lastSaved').textContent = `Last Saved: ${timeString}`;
        }

        function saveToStorage() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('discountCodes', JSON.stringify(discountCodes));
            localStorage.setItem('cart', JSON.stringify(cart));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('storeInfo', JSON.stringify(storeInfo));
            updateLastSaved();
            updateStorageUsage();
        }

        function getStorageUsage() {
            let total = 0;
            for (let x in localStorage) {
                if (localStorage.hasOwnProperty(x)) {
                    total += ((localStorage[x].length + x.length) * 2);
                }
            }
            return (total / 1024).toFixed(2); // KB
        }

        function updateStorageUsage() {
            const usage = getStorageUsage();
            document.getElementById('storageUsage').textContent = `${usage} KB`;
            if (usage > 4500) { // Warn at ~4.5 MB
                alert('Storage usage is high (>4.5 MB). Consider clearing old sales data to avoid reaching the 5 MB limit.');
            }
        }

        function clearOldSales() {
            const now = new Date();
            const thirtyDaysAgo = now.setDate(now.getDate() - 30);
            const initialLength = sales.length;
            sales = sales.filter(sale => new Date(sale.date.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3')).getTime() > thirtyDaysAgo);
            if (sales.length < initialLength) {
                saveToStorage();
                updateSalesList();
                alert(`${initialLength - sales.length} old sales cleared.`);
            } else {
                alert('No sales older than 30 days found.');
            }
        }

        function convertToCurrency(amount, targetCurrency) {
            return (amount * exchangeRates[targetCurrency]).toFixed(2);
        }

        function saveStoreInfo() {
            const oldCurrency = storeInfo.currency;
            storeInfo = {
                name: document.getElementById('storeName').value || 'Your company Ltd',
                address: document.getElementById('storeAddress').value || '123 Main Street, New York 0155, USA',
                orgNr: document.getElementById('storeOrgNr').value || 'VAT 123 456 789',
                email: document.getElementById('storeEmail').value || 'contact@example.com',
                phone: document.getElementById('storePhone').value || '123-456-7890',
                currency: document.getElementById('storeCurrency').value || '$'
            };
            if (oldCurrency !== storeInfo.currency) {
                updateCart();
                updateProductList();
                updateSalesList();
            }
            saveToStorage();
            alert('Store settings saved!');
            loadStoreInfo();
        }

        function loadStoreInfo() {
            document.getElementById('storeName').value = storeInfo.name;
            document.getElementById('storeAddress').value = storeInfo.address;
            document.getElementById('storeOrgNr').value = storeInfo.orgNr;
            document.getElementById('storeEmail').value = storeInfo.email;
            document.getElementById('storePhone').value = storeInfo.phone;
            document.getElementById('storeCurrency').value = storeInfo.currency;
            document.getElementById('currencySymbol').textContent = storeInfo.currency;
            document.getElementById('earningsCurrency').textContent = storeInfo.currency;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                products = [];
                discountCodes = [];
                cart = [];
                sales = [];
                categories = ['General'];
                storeInfo = {
                    name: 'Your company Ltd',
                    address: '123 Main Street, New York 0155, USA',
                    orgNr: 'VAT 123 456 789',
                    email: 'contact@example.com',
                    phone: '123-456-7890',
                    currency: '$'
                };
                localStorage.setItem('theme', 'light');
                document.documentElement.classList.remove('dark');
                appliedDiscount = null;
                pdfDoc = null;
                selectedCategory = null;
                localStorage.clear();
                saveToStorage();
                updateProductList();
                updateProductGrid();
                updateCategoryFilter();
                updateCategoryList();
                updateDiscountCodeList();
                updateCart();
                updateSalesList();
                clearProductForm();
                clearDiscountForm();
                clearCategoryForm();
                loadStoreInfo();
                document.getElementById('discountCode').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerEmail').value = '';
                updateButtonStates();
                alert('All data has been cleared.');
            }
        }

        function updateButtonStates() {
            const downloadButton = document.getElementById('downloadButton');
            const printButton = document.getElementById('printButton');
            if (pdfDoc) {
                downloadButton.disabled = false;
                printButton.disabled = false;
            } else {
                downloadButton.disabled = true;
                printButton.disabled = true;
            }
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        function showTab(tab) {
            document.getElementById('cashier').style.display = tab === 'cashier' ? 'block' : 'none';
            document.getElementById('admin').style.display = tab === 'admin' ? 'block' : 'none';
            document.getElementById('settings').style.display = tab === 'settings' ? 'block' : 'none';
            if (tab === 'cashier') {
                updateCart();
                updateButtonStates();
            } else if (tab === 'admin') {
                updateSalesList();
                updateStorageUsage();
            } else if (tab === 'settings') {
                loadStoreInfo();
            }
        }

        function adminLogin() {
            const code = document.getElementById('adminCode').value;
            if (code === 'admin123') {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
            } else {
                alert('Incorrect admin password');
            }
        }

        function adminLogout() {
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminCode').value = '';
        }

        function loadAdminData() {
            updateProductGrid();
            updateProductList();
            updateCategoryFilter();
            updateCategoryList();
            updateDiscountCodeList();
            updateSalesList();
            updateStorageUsage();
        }

        function addCategory() {
            const name = document.getElementById('categoryName').value.trim();
            if (!name) {
                alert('Please enter a category name.');
                return;
            }
            if (categories.includes(name)) {
                alert('Category already exists.');
                return;
            }
            categories.push(name);
            saveToStorage();
            updateCategoryFilter();
            updateCategoryList();
            clearCategoryForm();
            alert('Category added successfully.');
        }

        function updateCategory() {
            if (!selectedCategory) {
                alert('Please select a category to update.');
                return;
            }
            const name = document.getElementById('categoryName').value.trim();
            if (!name) {
                alert('Please enter a category name.');
                return;
            }
            if (categories.includes(name)) {
                alert('Category already exists.');
                return;
            }
            const index = categories.indexOf(selectedCategory);
            categories[index] = name;
            products.forEach(product => {
                if (product.category === selectedCategory) {
                    product.category = name;
                }
            });
            saveToStorage();
            updateCategoryFilter();
            updateCategoryList();
            updateProductList();
            updateProductGrid();
            clearCategoryForm();
            alert('Category updated successfully.');
        }

        function deleteCategory(category) {
            if (category === 'General') {
                alert('Cannot delete the default "General" category.');
                return;
            }
            if (products.some(product => product.category === category)) {
                if (confirm(`The category "${category}" is used by some products. Deleting it will set those products to the "General" category. Proceed?`)) {
                    products.forEach(product => {
                        if (product.category === category) {
                            product.category = 'General';
                        }
                    });
                } else {
                    return;
                }
            }
            categories = categories.filter(cat => cat !== category);
            saveToStorage();
            updateCategoryFilter();
            updateCategoryList();
            updateProductList();
            updateProductGrid();
            clearCategoryForm();
            alert('Category deleted successfully.');
        }

        function clearCategoryForm() {
            document.getElementById('categoryName').value = '';
            selectedCategory = null;
        }

        function updateCategoryList() {
            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            categories.forEach(category => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                li.textContent = category;
                const buttonDiv = document.createElement('div');
                buttonDiv.className = 'space-x-2';
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600';
                editBtn.onclick = () => {
                    selectedCategory = category;
                    document.getElementById('categoryName').value = category;
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600';
                deleteBtn.onclick = () => deleteCategory(category);
                buttonDiv.appendChild(editBtn);
                buttonDiv.appendChild(deleteBtn);
                li.appendChild(buttonDiv);
                list.appendChild(li);
            });
        }

        function addProduct() {
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value); // Price in USD
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const barcode = document.getElementById('productBarcode').value;
            const category = document.getElementById('productCategory').value;
            const canDiscount = document.querySelector('input[name="canDiscount"]:checked').value === 'true';
            const bulkQuantity = parseInt(document.getElementById('bulkQuantity').value) || 0;
            const bulkDiscount = parseFloat(document.getElementById('bulkDiscount').value) || 0;
            const imageInput = document.getElementById('productImage');
            let imageData = null;

            if (!name || isNaN(price)) {
                alert('Please enter a valid product name and price.');
                return;
            }

            if (!categories.includes(category) && category !== 'General') {
                categories.push(category);
                saveToStorage();
                updateCategoryFilter();
                updateCategoryList();
            }

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    products.push({ id: Date.now(), name, price, stock, barcode, category, canDiscount, bulkQuantity, bulkDiscount, image: imageData });
                    saveToStorage();
                    updateProductList();
                    updateProductGrid();
                    clearProductForm();
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                products.push({ id: Date.now(), name, price, stock, barcode, category, canDiscount, bulkQuantity, bulkDiscount, image: null });
                saveToStorage();
                updateProductList();
                updateProductGrid();
                clearProductForm();
            }
        }

        function updateProduct() {
            if (!selectedProduct) return;
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const barcode = document.getElementById('productBarcode').value;
            const category = document.getElementById('productCategory').value;
            const canDiscount = document.querySelector('input[name="canDiscount"]:checked').value === 'true';
            const bulkQuantity = parseInt(document.getElementById('bulkQuantity').value) || 0;
            const bulkDiscount = parseFloat(document.getElementById('bulkDiscount').value) || 0;
            const imageInput = document.getElementById('productImage');
            let imageData = selectedProduct.image;

            if (!name || isNaN(price)) {
                alert('Please enter a valid product name and price.');
                return;
            }

            if (!categories.includes(category) && category !== 'General') {
                categories.push(category);
                saveToStorage();
                updateCategoryFilter();
                updateCategoryList();
            }

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    const index = products.findIndex(p => p.id === selectedProduct.id);
                    products[index] = { ...selectedProduct, name, price, stock, barcode, category, canDiscount, bulkQuantity, bulkDiscount, image: imageData };
                    saveToStorage();
                    updateProductList();
                    updateProductGrid();
                    clearProductForm();
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                const index = products.findIndex(p => p.id === selectedProduct.id);
                products[index] = { ...selectedProduct, name, price, stock, barcode, category, canDiscount, bulkQuantity, bulkDiscount, image: imageData };
                saveToStorage();
                updateProductList();
                updateProductGrid();
                clearProductForm();
            }
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(p => p.id !== productId);
                cart = cart.filter(item => item.productId !== productId);
                saveToStorage();
                updateProductList();
                updateProductGrid();
            }
        }

        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productBarcode').value = '';
            document.getElementById('productCategory').value = 'General';
            document.getElementById('bulkQuantity').value = '';
            document.getElementById('bulkDiscount').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imagePreview').src = '';
            document.querySelector('input[name="canDiscount"][value="false"]').checked = true;
            selectedProduct = null;
        }

        function updateCategoryFilter() {
            const select = document.getElementById('productCategory');
            const filterSelect = document.getElementById('categoryFilter');
            select.innerHTML = '<option value="General">General</option>';
            filterSelect.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(category => {
                if (category !== 'General') {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                    const filterOption = document.createElement('option');
                    filterOption.value = category;
                    filterOption.textContent = category;
                    filterSelect.appendChild(filterOption);
                }
            });
        }

        function filterProductsByCategory() {
            const category = document.getElementById('categoryFilter').value;
            updateProductGrid(category);
        }

        function openProductModal() {
            updateProductGrid();
            updateCategoryFilter();
            document.getElementById('productModal').style.display = 'flex';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
            cancelSelection();
        }

        function updateProductGrid(filterCategory = 'all') {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            const filteredProducts = filterCategory === 'all' ? products : products.filter(p => p.category === filterCategory);
            const currency = storeInfo.currency || '$';
            filteredProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = `product-card p-4 bg-white rounded-lg shadow-md ${product.stock <= 0 ? 'unavailable' : ''}`;
                card.innerHTML = `
                    ${product.image ? `<img src="${product.image}" alt="${product.name}" class="mb-2 rounded">` : '<div class="h-24 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-500">No Image</div>'}
                    <h3 class="text-sm font-semibold text-gray-800">${product.name}</h3>
                    <p class="text-sm text-gray-600">Price: ${convertToCurrency(product.price, currency)} ${currency}</p>
                    <p class="text-sm text-gray-600">Stock: ${product.stock}</p>
                    <p class="text-sm text-gray-600">Category: ${product.category}</p>
                `;
                if (product.stock > 0) {
                    card.onclick = () => selectProduct(product);
                }
                grid.appendChild(card);
            });
        }

        function selectProduct(product) {
            selectedProductId = product.id;
            document.getElementById('selectedProductName').textContent = product.name;
            document.getElementById('quantity').value = '1';
            document.getElementById('quantitySelector').classList.remove('hidden');
        }

        function increaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            let quantity = parseInt(quantityInput.value);
            const product = products.find(p => p.id === selectedProductId);
            if (product && quantity < product.stock) {
                quantityInput.value = quantity + 1;
            }
        }

        function decreaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            let quantity = parseInt(quantityInput.value);
            if (quantity > 1) {
                quantityInput.value = quantity - 1;
            }
        }

        function cancelSelection() {
            selectedProductId = null;
            document.getElementById('quantitySelector').classList.add('hidden');
            document.getElementById('selectedProductName').textContent = '';
            document.getElementById('quantity').value = '1';
        }

        function quickAddToCart() {
            const barcode = document.getElementById('barcodeInput').value;
            const product = products.find(p => p.barcode === barcode);
            if (product && product.stock > 0) {
                const existingItem = cart.find(item => item.productId === product.id);
                const newQuantity = existingItem ? existingItem.quantity + 1 : 1;
                if (newQuantity > product.stock) {
                    alert(`Not enough stock! Only ${product.stock} ${product.name} available.`);
                    return;
                }
                if (existingItem) {
                    existingItem.quantity = newQuantity;
                } else {
                    cart.push({ productId: product.id, quantity: 1 });
                }
                document.getElementById('barcodeInput').value = '';
                saveToStorage();
                updateCart();
            } else {
                alert('Invalid barcode or out of stock!');
            }
        }

        function addDiscountCode() {
            const code = document.getElementById('discountCodeInput').value;
            const percent = parseFloat(document.getElementById('discountPercent').value);
            if (code && percent && percent >= 0 && percent <= 100) {
                discountCodes.push({ id: Date.now(), code, percent });
                saveToStorage();
                updateDiscountCodeList();
                clearDiscountForm();
            } else {
                alert('Please enter a valid discount code and percentage (0-100).');
            }
        }

        function updateDiscountCode() {
            if (!selectedDiscountCode) return;
            const code = document.getElementById('discountCodeInput').value;
            const percent = parseFloat(document.getElementById('discountPercent').value);
            if (code && percent && percent >= 0 && percent <= 100) {
                const index = discountCodes.findIndex(dc => dc.id === selectedDiscountCode.id);
                discountCodes[index] = { ...selectedDiscountCode, code, percent };
                saveToStorage();
                updateDiscountCodeList();
                clearDiscountForm();
            } else {
                alert('Please enter a valid discount code and percentage (0-100).');
            }
        }

        function clearDiscountForm() {
            document.getElementById('discountCodeInput').value = '';
            document.getElementById('discountPercent').value = '';
            selectedDiscountCode = null;
        }

        function updateDiscountCodeList() {
            const list = document.getElementById('discountCodeList');
            list.innerHTML = '';
            discountCodes.forEach(dc => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                li.textContent = `${dc.code} - ${dc.percent}%`;
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600';
                editBtn.onclick = () => {
                    selectedDiscountCode = dc;
                    document.getElementById('discountCodeInput').value = dc.code;
                    document.getElementById('discountPercent').value = dc.percent;
                };
                li.appendChild(editBtn);
                list.appendChild(li);
            });
        }

        function addToCart() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const product = products.find(p => p.id === selectedProductId);

            if (product && quantity > 0 && selectedProductId) {
                if (quantity > product.stock) {
                    alert(`Not enough stock! Only ${product.stock} ${product.name} available.`);
                    return;
                }
                const existingItem = cart.find(item => item.productId === product.id);
                const newQuantity = existingItem ? existingItem.quantity + quantity : quantity;
                if (newQuantity > product.stock) {
                    alert(`Total quantity (${newQuantity}) exceeds stock (${product.stock}) for ${product.name}!`);
                    return;
                }
                if (existingItem) {
                    existingItem.quantity = newQuantity;
                } else {
                    cart.push({ productId: product.id, quantity });
                }
                saveToStorage();
                updateCart();
                closeProductModal();
            }
        }

        function registerPurchase() {
            if (cart.length === 0) {
                alert('The cart is empty!');
                return;
            }
            let canProceed = true;
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product && item.quantity > product.stock) {
                    canProceed = false;
                    alert(`Not enough stock for ${product.name}! Only ${product.stock} available.`);
                }
            });
            if (!canProceed) return;

            const currency = storeInfo.currency || '$';
            const saleItems = cart.map(item => {
                const product = products.find(p => p.id === item.productId);
                return { name: product.name, quantity: item.quantity, price: parseFloat(convertToCurrency(product.price, currency)) };
            });
            const now = new Date();
            const sale = {
                id: Date.now(),
                receiptNumber: `REC-${Date.now()}`,
                date: now.toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                items: saleItems,
                total: parseFloat(convertToCurrency(total, '$')), // Store total in USD
                customerName: document.getElementById('customerName').value || 'N/A',
                customerEmail: document.getElementById('customerEmail').value || 'N/A'
            };
            sales.push(sale);

            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.stock -= item.quantity;
                }
            });
            saveToStorage();
            generateReceipt();
            cart = [];
            appliedDiscount = null;
            document.getElementById('discountCode').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            updateCart();
            updateProductGrid();
            updateSalesList();
        }

        function applyDiscount() {
            const code = document.getElementById('discountCode').value;
            const discount = discountCodes.find(dc => dc.code === code);
            if (discount) {
                appliedDiscount = discount;
                updateCart();
            } else {
                alert('Invalid discount code');
                appliedDiscount = null;
                updateCart();
            }
        }

        function updateCart() {
            const list = document.getElementById('cartItems');
            list.innerHTML = '';
            total = 0;
            const currency = storeInfo.currency || '$';

            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return;

                let itemPrice = product.price * item.quantity; // In USD
                let discountText = '';

                if (product.bulkQuantity && item.quantity >= product.bulkQuantity) {
                    const discount = product.bulkDiscount / 100;
                    itemPrice *= (1 - discount);
                    discountText = ` (Bulk Discount ${product.bulkDiscount}%)`;
                }

                if (appliedDiscount && product.canDiscount) {
                    const discount = appliedDiscount.percent / 100;
                    itemPrice *= (1 - discount);
                    discountText += ` (Code ${appliedDiscount.percent}%)`;
                }

                total += itemPrice;

                const li = document.createElement('li');
                li.className = 'p-2 bg-gray-50 rounded';
                li.textContent = `${product.name} x${item.quantity} - ${convertToCurrency(itemPrice, currency)} ${currency}${discountText} (Stock: ${product.stock})`;
                list.appendChild(li);
            });

            document.getElementById('total').textContent = convertToCurrency(total, currency);
            document.getElementById('currencySymbol').textContent = currency;
            updateButtonStates();
        }

        function updateSalesList() {
            const list = document.getElementById('salesList');
            list.innerHTML = '';
            const currency = storeInfo.currency || '$';
            let totalEarnings = 0;
            sales.forEach(sale => {
                totalEarnings += sale.total; // Total in USD
                const li = document.createElement('li');
                li.className = 'p-2 bg-gray-50 rounded';
                li.textContent = `Sale ${sale.receiptNumber} - ${sale.date} - Total: ${convertToCurrency(sale.total, currency)} ${currency} (Customer: ${sale.customerName})`;
                list.appendChild(li);
            });
            document.getElementById('totalEarnings').textContent = convertToCurrency(totalEarnings, currency);
            document.getElementById('earningsCurrency').textContent = currency;
        }

        function exportSalesToCSV() {
            const currency = storeInfo.currency || '$';
            let csv = 'Receipt Number,Date,Total,Customer Name,Customer Email,Items\n';
            sales.forEach(sale => {
                const items = sale.items.map(item => `${item.name} (x${item.quantity})`).join(';');
                csv += `${sale.receiptNumber},${sale.date},${convertToCurrency(sale.total, currency)} ${currency},${sale.customerName},${sale.customerEmail},"${items}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sales.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearCart() {
            cart = [];
            appliedDiscount = null;
            pdfDoc = null;
            document.getElementById('discountCode').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            saveToStorage();
            updateCart();
            updateButtonStates();
        }

        async function generateReceipt() {
            if (cart.length === 0) {
                alert('The cart is empty! Add products before generating a receipt.');
                return;
            }
            const { jsPDF } = window.jspdf;
            pdfDoc = new jsPDF();
            const pageWidth = pdfDoc.internal.pageSize.getWidth();
            let y = 20;
            const currency = storeInfo.currency || '$';

            // Store Header
            pdfDoc.setFontSize(16);
            pdfDoc.setFont("helvetica", "bold");
            pdfDoc.text(storeInfo.name, pageWidth / 2, y, { align: "center" });
            y += 10;
            pdfDoc.setFontSize(10);
            pdfDoc.setFont("helvetica", "normal");
            pdfDoc.text(storeInfo.address, pageWidth / 2, y, { align: "center" });
            y += 6;
            pdfDoc.text(storeInfo.orgNr, pageWidth / 2, y, { align: "center" });
            y += 10;

            // Customer Info
            const customerName = document.getElementById('customerName').value || 'N/A';
            const customerEmail = document.getElementById('customerEmail').value || 'N/A';
            pdfDoc.text(`Customer: ${customerName}`, 20, y);
            y += 6;
            pdfDoc.text(`Email: ${customerEmail}`, 20, y);
            y += 10;

            // Receipt Title and Details
            pdfDoc.setFontSize(14);
            pdfDoc.setFont("helvetica", "bold");
            pdfDoc.text("Receipt", pageWidth / 2, y, { align: "center" });
            y += 10;
            pdfDoc.setFontSize(10);
            pdfDoc.setFont("helvetica", "normal");
            const now = new Date();
            const receiptNumber = `REC-${Date.now()}`;
            const dateString = now.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            pdfDoc.text(`Receipt No: ${receiptNumber}`, 20, y);
            pdfDoc.text(`Date: ${dateString}`, pageWidth - 20, y, { align: "right" });
            y += 10;

            // Line Separator
            pdfDoc.setLineWidth(0.5);
            pdfDoc.line(20, y, pageWidth - 20, y);
            y += 10;

            // Items Header
            pdfDoc.setFont("helvetica", "bold");
            pdfDoc.text("Item", 20, y);
            pdfDoc.text("Quantity", 100, y);
            pdfDoc.text("Price", 140, y);
            pdfDoc.text("Total", pageWidth - 20, y, { align: "right" });
            y += 6;
            pdfDoc.setLineWidth(0.2);
            pdfDoc.line(20, y, pageWidth - 20, y);
            y += 6;

            // Items List
            pdfDoc.setFont("helvetica", "normal");
            let subtotal = 0;
            let discountTotal = 0;
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    let itemPrice = product.price * item.quantity; // In USD
                    let discountText = '';
                    let discountAmount = 0;

                    if (product.bulkQuantity && item.quantity >= product.bulkQuantity) {
                        const discount = product.bulkDiscount / 100;
                        discountAmount += itemPrice * discount;
                        itemPrice *= (1 - discount);
                        discountText = ` (Bulk Discount ${product.bulkDiscount}%)`;
                    }
                    if (appliedDiscount && product.canDiscount) {
                        const discount = appliedDiscount.percent / 100;
                        discountAmount += itemPrice * discount;
                        itemPrice *= (1 - discount);
                        discountText += ` (Code ${appliedDiscount.percent}%)`;
                    }

                    subtotal += product.price * item.quantity;
                    discountTotal += discountAmount;

                    pdfDoc.text(product.name, 20, y);
                    pdfDoc.text(`x${item.quantity}`, 100, y);
                    pdfDoc.text(`${convertToCurrency(product.price, currency)} ${currency}`, 140, y);
                    pdfDoc.text(`${convertToCurrency(itemPrice, currency)} ${currency}${discountText}`, pageWidth - 20, y, { align: "right" });
                    y += 6;
                }
            });

            // Totals and Taxes
            y += 5;
            pdfDoc.setLineWidth(0.5);
            pdfDoc.line(20, y, pageWidth - 20, y);
            y += 10;
            pdfDoc.setFont("helvetica", "bold");
            pdfDoc.text("Subtotal:", 20, y);
            pdfDoc.text(`${convertToCurrency(subtotal, currency)} ${currency}`, pageWidth - 20, y, { align: "right" });
            y += 6;
            if (discountTotal > 0) {
                pdfDoc.text("Discounts:", 20, y);
                pdfDoc.text(`-${convertToCurrency(discountTotal, currency)} ${currency}`, pageWidth - 20, y, { align: "right" });
                y += 6;
            }
            const vat = total * 0.25;
            const exVat = total - vat;
            pdfDoc.text("VAT (25%):", 20, y);
            pdfDoc.text(`${convertToCurrency(vat, currency)} ${currency}`, pageWidth - 20, y, { align: "right" });
            y += 6;
            pdfDoc.text("Total excl. VAT:", 20, y);
            pdfDoc.text(`${convertToCurrency(exVat, currency)} ${currency}`, pageWidth - 20, y, { align: "right" });
            y += 10;
            pdfDoc.setFontSize(12);
            pdfDoc.text("Total:", 20, y);
            pdfDoc.text(`${convertToCurrency(total, currency)} ${currency}`, pageWidth - 20, y, { align: "right" });

            // Footer
            y += 15;
            pdfDoc.setLineWidth(0.5);
            pdfDoc.line(20, y, pageWidth - 20, y);
            y += 10;
            pdfDoc.setFontSize(10);
            pdfDoc.text("Thank you for your purchase!", pageWidth / 2, y, { align: "center" });
            y += 6;
            pdfDoc.text(`Contact: ${storeInfo.email} | Phone: ${storeInfo.phone}`, pageWidth / 2, y, { align: "center" });

            // HTML Receipt Content
            const content = document.getElementById('receiptContent');
            content.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800">Receipt</h3>
                <p class="text-gray-700">${storeInfo.name}</p>
                <p class="text-gray-700">${storeInfo.address}</p>
                <p class="text-gray-700">${storeInfo.orgNr}</p>
                <p class="text-gray-700 mt-2">Customer: ${customerName}</p>
                <p class="text-gray-700">Email: ${customerEmail}</p>
                <p class="text-gray-700 mt-2">Receipt No: ${receiptNumber}</p>
                <p class="text-gray-700">Date: ${dateString}</p>
                <hr class="my-2 border-gray-300">
                <table class="w-full text-gray-700">
                    <thead>
                        <tr>
                            <th class="text-left font-semibold">Item</th>
                            <th class="text-center font-semibold">Quantity</th>
                            <th class="text-right font-semibold">Price</th>
                            <th class="text-right font-semibold">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    let itemPrice = product.price * item.quantity;
                    let discountText = '';
                    if (product.bulkQuantity && item.quantity >= product.bulkQuantity) {
                        const discount = product.bulkDiscount / 100;
                        itemPrice *= (1 - discount);
                        discountText = ` (Bulk Discount ${product.bulkDiscount}%)`;
                    }
                    if (appliedDiscount && product.canDiscount) {
                        const discount = appliedDiscount.percent / 100;
                        itemPrice *= (1 - discount);
                        discountText += ` (Code ${appliedDiscount.percent}%)`;
                    }
                    content.innerHTML += `
                        <tr>
                            <td>${product.name}</td>
                            <td class="text-center">x${item.quantity}</td>
                            <td class="text-right">${convertToCurrency(product.price, currency)} ${currency}</td>
                            <td class="text-right">${convertToCurrency(itemPrice, currency)} ${currency}${discountText}</td>
                        </tr>
                    `;
                }
            });
            content.innerHTML += `
                    </tbody>
                </table>
                <hr class="my-2 border-gray-300">
                <p class="text-gray-700">Subtotal: ${convertToCurrency(subtotal, currency)} ${currency}</p>
                ${discountTotal > 0 ? `<p class="text-gray-700">Discounts: -${convertToCurrency(discountTotal, currency)} ${currency}</p>` : ''}
                <p class="text-gray-700">VAT (25%): ${convertToCurrency(vat, currency)} ${currency}</p>
                <p class="text-gray-700">Total excl. VAT: ${convertToCurrency(exVat, currency)} ${currency}</p>
                <p class="text-lg font-semibold text-gray-800">Total: ${convertToCurrency(total, currency)} ${currency}</p>
                <p class="text-center text-gray-700 mt-4">Thank you for your purchase!</p>
                <p class="text-center text-gray-700">Contact: ${storeInfo.email} | Phone: ${storeInfo.phone}</p>
            `;

            // PDF Preview
            const pdfDataUri = pdfDoc.output('datauristring');
            const preview = document.getElementById('pdfPreview');
            preview.innerHTML = '<canvas id="pdfCanvas"></canvas>';
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');

            try {
                const pdf = await pdfjsLib.getDocument(pdfDataUri).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 1 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
            } catch (error) {
                console.error('Error rendering PDF preview:', error);
                alert('Could not generate PDF preview. Please try again.');
                pdfDoc = null;
                updateButtonStates();
                return;
            }

            document.getElementById('receiptModal').style.display = 'block';
            updateButtonStates();
        }

        function closeReceipt() {
            document.getElementById('receiptModal').style.display = 'none';
            document.getElementById('pdfPreview').innerHTML = '';
        }

        function downloadReceipt() {
            if (!pdfDoc) {
                alert('Generate a receipt first by clicking "Generate Receipt"!');
                return;
            }
            try {
                pdfDoc.save('receipt.pdf');
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Could not download the receipt. Please try generating the receipt again.');
            }
        }

        function printReceipt() {
            if (!pdfDoc) {
                alert('Generate a receipt first by clicking "Generate Receipt"!');
                return;
            }
            try {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><body><iframe src="' + pdfDoc.output('datauristring') + '" style="width:100%;height:100%"></iframe></body></html>');
                printWindow.document.close();
                printWindow.onload = () => {
                    try {
                        printWindow.print();
                    } catch (error) {
                        console.error('Error printing:', error);
                        alert('Could not print the receipt. Please try again or download the PDF.');
                        printWindow.close();
                    }
                };
            } catch (error) {
                console.error('Error opening print window:', error);
                alert('Could not print the receipt. Please try again or download the PDF.');
            }
        }

        function emailReceipt() {
            if (!pdfDoc) {
                alert('Generate a receipt first by clicking "Generate Receipt"!');
                return;
            }
            const customerEmail = document.getElementById('customerEmail').value;
            if (!customerEmail) {
                alert('Please enter a customer email to send the receipt.');
                return;
            }
            const pdfDataUri = pdfDoc.output('datauristring');
            const base64Data = pdfDataUri.split(',')[1]; // Extract base64 part
            navigator.clipboard.writeText(base64Data).then(() => {
                const subject = encodeURIComponent(`Receipt from ${storeInfo.name}`);
                const body = encodeURIComponent(`Dear Customer,\n\nYour receipt from ${storeInfo.name} has been copied to your clipboard as a base64-encoded PDF. Please paste it into a base64 decoder (e.g., https://base64.guru/converter/decode/pdf) to retrieve the PDF, then attach it to this email.\n\nBest regards,\n${storeInfo.name}`);
                window.location.href = `mailto:${customerEmail}?subject=${subject}&body=${body}`;
                alert('PDF data copied to clipboard! Opening email client. Paste the data into a base64 decoder to attach the PDF.');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('Failed to copy PDF data. Please try downloading the PDF instead.');
            });
        }

        function updateProductList() {
            const list = document.getElementById('productList');
            list.innerHTML = '';
            const currency = storeInfo.currency || '$';
            products.forEach(product => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                li.textContent = `${product.name} - ${convertToCurrency(product.price, currency)} ${currency} (Stock: ${product.stock}, Category: ${product.category}, Barcode: ${product.barcode || 'N/A'}, Discount: ${product.canDiscount ? 'Yes' : 'No'}, Bulk Discount: ${product.bulkQuantity ? `${product.bulkQuantity} units, ${product.bulkDiscount}%` : 'None'})`;
                const buttonDiv = document.createElement('div');
                buttonDiv.className = 'space-x-2';
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600';
                editBtn.onclick = () => {
                    selectedProduct = product;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productBarcode').value = product.barcode || '';
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('bulkQuantity').value = product.bulkQuantity;
                    document.getElementById('bulkDiscount').value = product.bulkDiscount;
                    document.querySelector(`input[name="canDiscount"][value="${product.canDiscount}"]`).checked = true;
                    if (product.image) {
                        document.getElementById('imagePreview').src = product.image;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    } else {
                        document.getElementById('imagePreview').classList.add('hidden');
                    }
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600';
                deleteBtn.onclick = () => deleteProduct(product.id);
                buttonDiv.appendChild(editBtn);
                buttonDiv.appendChild(deleteBtn);
                li.appendChild(buttonDiv);
                list.appendChild(li);
            });
        }

        // Image Preview Handler
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').classList.add('hidden');
            }
        });

        // Initialize
        updateLastSaved();
        updateCart();
        updateButtonStates();
        loadStoreInfo();
        updateCategoryFilter();
        updateCategoryList();
        updateStorageUsage();
    </script>
</body>
</html>